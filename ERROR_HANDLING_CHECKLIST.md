# ‚úÖ Kriteria 5: Error Handling Implementation Checklist

## üìã Status: **SEMUA ERROR HANDLING SUDAH DITERAPKAN**

Aplikasi OpenMusic API sudah menerapkan Error Handling yang lengkap dan sesuai dengan kriteria. Berikut adalah detail implementasinya:

---

## üéØ Error Response Structure

Semua error response mengikuti struktur yang konsisten:

### **Client Errors (4xx):**
```json
{
  "status": "fail",
  "message": "<error message>"
}
```

### **Server Errors (5xx):**
```json
{
  "status": "error",
  "message": "<error message>"
}
```

---

## üîç Error Handling Implementation

### **1. ‚úÖ Validasi Data Gagal (400 - Bad Request)**

**Kriteria:**
- Status code: 400
- Response body: `status: "fail"`, `message: <tidak kosong>`

**Implementation:**

**Exception Class:** `src/exceptions/InvariantError.js`
```javascript
class InvariantError extends ClientError {
  constructor(message) {
    super(message, 400);  // ‚¨ÖÔ∏è Status code 400
    this.name = 'InvariantError';
  }
}
```

**Usage Examples:**

**a) Validation Error (Missing Field):**
```javascript
// src/validator/users.js
if (!username || !password || !fullname) {
  throw new InvariantError('Gagal menambahkan user. Mohon isi semua field yang diperlukan');
}
```

**Request:**
```json
POST /users
{
  "username": "johndoe",
  "password": "secret123"
  // fullname missing
}
```

**Response (400):**
```json
{
  "status": "fail",
  "message": "Gagal menambahkan user. Mohon isi semua field yang diperlukan"
}
```

**b) Validation Error (Wrong Type):**
```javascript
// src/validator/playlists.js
if (typeof name !== 'string') {
  throw new InvariantError('Gagal menambahkan playlist. Tipe data tidak sesuai');
}
```

**Request:**
```json
POST /playlists
{
  "name": 12345  // number instead of string
}
```

**Response (400):**
```json
{
  "status": "fail",
  "message": "Gagal menambahkan playlist. Tipe data tidak sesuai"
}
```

**c) Invalid Refresh Token:**
```javascript
// src/services/AuthenticationsService.js
async verifyRefreshToken(token) {
  const result = await this.query(/* ... */);
  
  if (!result.rows.length) {
    throw new InvariantError('Refresh token tidak valid');
  }
}
```

**Request:**
```json
PUT /authentications
{
  "refreshToken": "invalid_or_expired_token"
}
```

**Response (400):**
```json
{
  "status": "fail",
  "message": "Refresh token tidak valid"
}
```

---

### **2. ‚úÖ Resource Tidak Ditemukan (404 - Not Found)**

**Kriteria:**
- Status code: 404
- Response body: `status: "fail"`, `message: <tidak kosong>`

**Implementation:**

**Exception Class:** `src/exceptions/NotFoundError.js`
```javascript
class NotFoundError extends ClientError {
  constructor(message) {
    super(message, 404);  // ‚¨ÖÔ∏è Status code 404
    this.name = 'NotFoundError';
  }
}
```

**Usage Examples:**

**a) Playlist Not Found:**
```javascript
// src/services/PlaylistsService.js
async verifyPlaylistOwner(id, owner) {
  const result = await this.query(/* ... */);
  
  if (!result.rows.length) {
    throw new NotFoundError('Playlist tidak ditemukan');
  }
  // ...
}
```

**Request:**
```json
GET /playlists/playlist-nonexistent/songs
Authorization: Bearer <token>
```

**Response (404):**
```json
{
  "status": "fail",
  "message": "Playlist tidak ditemukan"
}
```

**b) Song Not Found:**
```javascript
// src/api/playlists/handler.js
try {
  await this._songsService.getSongById(songId);
} catch (error) {
  if (error.name === 'NotFoundError') {
    return h.response({
      status: 'fail',
      message: 'Lagu tidak ditemukan',
    }).code(404);
  }
  throw error;
}
```

**Request:**
```json
POST /playlists/playlist-xxx/songs
Authorization: Bearer <token>
{
  "songId": "song-nonexistent"
}
```

**Response (404):**
```json
{
  "status": "fail",
  "message": "Lagu tidak ditemukan"
}
```

**c) Album/Song Not Found (Generic):**
```javascript
// src/services/AlbumsService.js / SongsService.js
async getById(id) {
  const result = await this.query(/* ... */);
  
  if (!result.rows.length) {
    throw new NotFoundError('Album/Song tidak ditemukan');
  }
  
  return result.rows[0];
}
```

---

### **3. ‚úÖ Akses Tanpa Access Token (401 - Unauthorized)**

**Kriteria:**
- Status code: 401
- Response body: `status: "fail"`, `message: <tidak kosong>`

**Implementation:**

**Exception Class:** `src/exceptions/AuthenticationError.js`
```javascript
class AuthenticationError extends ClientError {
  constructor(message) {
    super(message, 401);  // ‚¨ÖÔ∏è Status code 401
    this.name = 'AuthenticationError';
  }
}
```

**Hapi JWT Plugin Handling:**

Ketika user mencoba mengakses protected endpoint tanpa token, Hapi JWT plugin otomatis mengembalikan 401.

**Route Configuration:**
```javascript
// src/api/playlists/routes.js
{
  method: 'POST',
  path: '/playlists',
  handler: handler.postPlaylistHandler,
  options: {
    auth: 'openmusic_jwt',  // ‚¨ÖÔ∏è Requires authentication
  },
}
```

**Request (No Token):**
```json
POST /playlists
Content-Type: application/json
{
  "name": "My Playlist"
}
```

**Response (401):**
```json
{
  "status": "fail",
  "message": "Missing authentication"
}
```

**Request (Invalid Token):**
```json
POST /playlists
Authorization: Bearer invalid_token_here
Content-Type: application/json
{
  "name": "My Playlist"
}
```

**Response (401):**
```json
{
  "status": "fail",
  "message": "Invalid token"
}
```

**Usage in Service (Credential Verification):**
```javascript
// src/services/UsersService.js
async verifyUserCredential(username, password) {
  const result = await this.query(/* ... */);
  
  if (!result.rows.length) {
    throw new InvariantError('Kredensial yang Anda berikan salah');
  }
  
  const match = await bcrypt.compare(password, hashedPassword);
  
  if (!match) {
    throw new InvariantError('Kredensial yang Anda berikan salah');
  }
  
  return id;
}
```

**Note:** Untuk credential verification, menggunakan InvariantError (400) bukan AuthenticationError sesuai best practice (tidak membocorkan informasi username valid/tidak).

---

### **4. ‚úÖ Refresh Token Tidak Valid (400 - Bad Request)**

**Kriteria:**
- Status code: 400
- Response body: `status: "fail"`, `message: <tidak kosong>`

**Implementation:**

Sudah tercover di poin #1 (InvariantError).

**Example:**
```javascript
// src/services/AuthenticationsService.js
async verifyRefreshToken(token) {
  const result = await this.query(
    'SELECT token FROM authentications WHERE token = $1',
    [token]
  );
  
  if (!result.rows.length) {
    throw new InvariantError('Refresh token tidak valid');
  }
}
```

**Request:**
```json
PUT /authentications
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.expired_or_invalid"
}
```

**Response (400):**
```json
{
  "status": "fail",
  "message": "Refresh token tidak valid"
}
```

**Additional Validation (TokenManager):**
```javascript
// src/tokenize/TokenManager.js
verifyRefreshToken: (refreshToken) => {
  try {
    const artifacts = Jwt.token.decode(refreshToken);
    Jwt.token.verifySignature(artifacts, process.env.REFRESH_TOKEN_KEY);
    return artifacts.decoded.payload;
  } catch (error) {
    throw new InvariantError('Refresh token tidak valid');
  }
}
```

---

### **5. ‚úÖ Akses Resource Bukan Miliknya (403 - Forbidden)**

**Kriteria:**
- Status code: 403
- Response body: `status: "fail"`, `message: <tidak kosong>`

**Implementation:**

**Exception Class:** `src/exceptions/AuthorizationError.js`
```javascript
class AuthorizationError extends ClientError {
  constructor(message) {
    super(message, 403);  // ‚¨ÖÔ∏è Status code 403
    this.name = 'AuthorizationError';
  }
}
```

**Usage Example:**
```javascript
// src/services/PlaylistsService.js
async verifyPlaylistOwner(id, owner) {
  const query = {
    text: 'SELECT * FROM playlists WHERE id = $1',
    values: [id],
  };

  const result = await this.query(query.text, query.values);

  if (!result.rows.length) {
    throw new NotFoundError('Playlist tidak ditemukan');
  }

  const playlist = result.rows[0];

  if (playlist.owner !== owner) {
    throw new AuthorizationError('Anda tidak berhak mengakses resource ini');
  }
}
```

**Handler Integration:**
```javascript
// src/api/playlists/handler.js
async postSongToPlaylistHandler(request, h) {
  const { id } = request.params;
  const { userId } = request.auth.credentials;

  // Verify ownership/access (throws AuthorizationError if not owner)
  await this._playlistsService.verifyPlaylistOwner(id, userId);

  // ... rest of handler
}
```

**Scenario:**

**User A** (userId: `user-abc123`) tries to add song to **User B**'s playlist:

**Request:**
```json
POST /playlists/playlist-owned-by-user-b/songs
Authorization: Bearer <user-a-token>
Content-Type: application/json
{
  "songId": "song-xxx"
}
```

**Response (403):**
```json
{
  "status": "fail",
  "message": "Anda tidak berhak mengakses resource ini"
}
```

---

### **6. ‚úÖ Server Error (500 - Internal Server Error)**

**Kriteria:**
- Status code: 500
- Response body: `status: "error"`, `message: <tidak kosong>`

**Implementation:**

**Global Error Handler:** `src/server.js`
```javascript
// Error handling extension
server.ext('onPreResponse', (request, h) => {
  const { response } = request;

  if (response instanceof Error) {
    // Handle client errors (4xx)
    if (response instanceof ClientError) {
      const newResponse = h.response({
        status: 'fail',  // ‚¨ÖÔ∏è Client errors use "fail"
        message: response.message,
      });
      newResponse.code(response.statusCode);
      return newResponse;
    }

    // Handle server errors (5xx)
    if (!response.isServer) {
      return h.continue;
    }

    const newResponse = h.response({
      status: 'error',  // ‚¨ÖÔ∏è Server errors use "error"
      message: 'An internal server error occurred',
    });
    newResponse.code(500);
    console.error(response);  // Log error for debugging
    return newResponse;
  }

  return h.continue;
});
```

**Scenarios:**

**a) Database Connection Error:**
```javascript
// If database connection fails
try {
  const result = await this.query(/* ... */);
} catch (error) {
  // Error not caught by service ‚Üí bubbles to global handler
  // Response: 500 with "error" status
}
```

**Response (500):**
```json
{
  "status": "error",
  "message": "An internal server error occurred"
}
```

**b) Unhandled Exception:**
```javascript
// Any unexpected error (e.g., null reference, syntax error in runtime)
// Gets caught by global error handler
```

**Response (500):**
```json
{
  "status": "error",
  "message": "An internal server error occurred"
}
```

**Error Logging:**
- Server errors are logged to console with `console.error(response)`
- This helps debugging without exposing internal details to client

---

## üìä Error Handling Summary Table

| Scenario | Status Code | Status Field | Exception Class | Message Example |
|----------|-------------|--------------|-----------------|-----------------|
| Validation Failed | 400 | `fail` | `InvariantError` | "Gagal menambahkan user. Mohon isi semua field yang diperlukan" |
| Resource Not Found | 404 | `fail` | `NotFoundError` | "Playlist tidak ditemukan" |
| No Access Token | 401 | `fail` | Hapi JWT / `AuthenticationError` | "Missing authentication" |
| Invalid Refresh Token | 400 | `fail` | `InvariantError` | "Refresh token tidak valid" |
| Access Forbidden | 403 | `fail` | `AuthorizationError` | "Anda tidak berhak mengakses resource ini" |
| Server Error | 500 | `error` | Generic Error | "An internal server error occurred" |

---

## üèóÔ∏è Error Handling Architecture

```
Request ‚Üí Route Handler ‚Üí Validator/Service ‚Üí Exception Thrown
                                                    ‚Üì
                                            onPreResponse Hook
                                                    ‚Üì
                                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                        ‚îÇ                       ‚îÇ
                                  ClientError?             Server Error?
                                        ‚îÇ                       ‚îÇ
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
                              ‚îÇ                   ‚îÇ            ‚îÇ
                        InvariantError      NotFoundError      ‚îÇ
                        (400 Bad Request)   (404 Not Found)    ‚îÇ
                              ‚îÇ                   ‚îÇ            ‚îÇ
                        AuthenticationError  AuthorizationError‚îÇ
                        (401 Unauthorized)   (403 Forbidden)   ‚îÇ
                              ‚îÇ                   ‚îÇ            ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
                                        ‚Üì                      ‚Üì
                              { status: "fail" }    { status: "error" }
                                 message: xxx          message: xxx
                                 code: 4xx             code: 500
```

---

## üéØ Exception Class Hierarchy

```
Error (JavaScript Base)
  ‚îÇ
  ‚îî‚îÄ‚îÄ ClientError (Custom Base)
        ‚îÇ
        ‚îú‚îÄ‚îÄ InvariantError (400)
        ‚îÇ     ‚Üì Used for:
        ‚îÇ     - Validation errors
        ‚îÇ     - Invalid credentials
        ‚îÇ     - Invalid refresh token
        ‚îÇ     - Duplicate username
        ‚îÇ
        ‚îú‚îÄ‚îÄ NotFoundError (404)
        ‚îÇ     ‚Üì Used for:
        ‚îÇ     - Playlist not found
        ‚îÇ     - Song not found
        ‚îÇ     - Album not found
        ‚îÇ     - User not found
        ‚îÇ
        ‚îú‚îÄ‚îÄ AuthenticationError (401)
        ‚îÇ     ‚Üì Used for:
        ‚îÇ     - Missing token (handled by Hapi JWT)
        ‚îÇ     - Invalid token (handled by Hapi JWT)
        ‚îÇ
        ‚îî‚îÄ‚îÄ AuthorizationError (403)
              ‚Üì Used for:
              - Accessing others' playlists
              - Insufficient permissions
```

---

## ‚úÖ Kriteria 5 Checklist

- [x] ‚úÖ **400 Bad Request** - Validasi data gagal ‚Üí InvariantError
- [x] ‚úÖ **404 Not Found** - Resource tidak ditemukan ‚Üí NotFoundError
- [x] ‚úÖ **401 Unauthorized** - Akses tanpa token ‚Üí Hapi JWT / AuthenticationError
- [x] ‚úÖ **400 Bad Request** - Refresh token tidak valid ‚Üí InvariantError
- [x] ‚úÖ **403 Forbidden** - Akses resource bukan miliknya ‚Üí AuthorizationError
- [x] ‚úÖ **500 Internal Server Error** - Server error ‚Üí Global error handler
- [x] ‚úÖ Client errors menggunakan `status: "fail"`
- [x] ‚úÖ Server errors menggunakan `status: "error"`
- [x] ‚úÖ Semua response memiliki `message` yang tidak kosong
- [x] ‚úÖ Error handling di `onPreResponse` hook

---

## üß™ Testing Error Handling

### **Test 1: Validation Error (400)**
```bash
curl -X POST http://localhost:5000/users \
  -H "Content-Type: application/json" \
  -d '{"username":"test"}'

# Expected: 400 Bad Request
# Response: {"status":"fail","message":"Gagal menambahkan user. Mohon isi semua field yang diperlukan"}
```

### **Test 2: Not Found (404)**
```bash
curl -X GET http://localhost:5000/albums/album-notexist

# Expected: 404 Not Found
# Response: {"status":"fail","message":"Album tidak ditemukan"}
```

### **Test 3: Unauthorized (401)**
```bash
curl -X POST http://localhost:5000/playlists \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Playlist"}'

# Expected: 401 Unauthorized
# Response: {"status":"fail","message":"Missing authentication"}
```

### **Test 4: Invalid Refresh Token (400)**
```bash
curl -X PUT http://localhost:5000/authentications \
  -H "Content-Type: application/json" \
  -d '{"refreshToken":"invalid_token"}'

# Expected: 400 Bad Request
# Response: {"status":"fail","message":"Refresh token tidak valid"}
```

### **Test 5: Forbidden (403)**
```bash
# User A tries to access User B's playlist
curl -X POST http://localhost:5000/playlists/playlist-user-b/songs \
  -H "Authorization: Bearer <user-a-token>" \
  -H "Content-Type: application/json" \
  -d '{"songId":"song-xxx"}'

# Expected: 403 Forbidden
# Response: {"status":"fail","message":"Anda tidak berhak mengakses resource ini"}
```

### **Test 6: Server Error (500)**
```bash
# Simulate by stopping database or causing unhandled error
# Expected: 500 Internal Server Error
# Response: {"status":"error","message":"An internal server error occurred"}
```

---

## üìÅ File Structure

```
src/
‚îú‚îÄ‚îÄ exceptions/
‚îÇ   ‚îú‚îÄ‚îÄ ClientError.js              ‚úÖ Base class (400)
‚îÇ   ‚îú‚îÄ‚îÄ InvariantError.js           ‚úÖ 400 Bad Request
‚îÇ   ‚îú‚îÄ‚îÄ NotFoundError.js            ‚úÖ 404 Not Found
‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationError.js      ‚úÖ 401 Unauthorized
‚îÇ   ‚îî‚îÄ‚îÄ AuthorizationError.js       ‚úÖ 403 Forbidden
‚îÇ
‚îú‚îÄ‚îÄ server.js                       ‚úÖ Global error handler (onPreResponse)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ UsersService.js             ‚úÖ Throws InvariantError
‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationsService.js   ‚úÖ Throws InvariantError
‚îÇ   ‚îú‚îÄ‚îÄ PlaylistsService.js         ‚úÖ Throws NotFoundError, AuthorizationError
‚îÇ   ‚îú‚îÄ‚îÄ AlbumsService.js            ‚úÖ Throws NotFoundError
‚îÇ   ‚îî‚îÄ‚îÄ SongsService.js             ‚úÖ Throws NotFoundError
‚îÇ
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ playlists/
        ‚îî‚îÄ‚îÄ handler.js              ‚úÖ Catches NotFoundError, returns 404
```

---

## üí° Best Practices yang Diterapkan

### **1. Consistent Error Structure**
```javascript
// Client Errors (4xx)
{
  "status": "fail",
  "message": "<descriptive message>"
}

// Server Errors (5xx)
{
  "status": "error",
  "message": "<generic message>"
}
```

### **2. Inheritance Pattern**
All custom errors extend `ClientError` untuk konsistensi:
```javascript
ClientError (base) ‚Üí InvariantError, NotFoundError, etc.
```

### **3. Error Logging**
Server errors di-log ke console tanpa expose detail ke client:
```javascript
console.error(response);  // Log internal details
// Client hanya menerima: "An internal server error occurred"
```

### **4. Specific Error Messages**
Pesan error dalam bahasa Indonesia dan deskriptif:
- ‚úÖ "Gagal menambahkan user. Mohon isi semua field yang diperlukan"
- ‚úÖ "Playlist tidak ditemukan"
- ‚úÖ "Anda tidak berhak mengakses resource ini"
- ‚ùå "Error" (terlalu generic)

### **5. Security Considerations**
- ‚úÖ Server errors tidak expose stack trace atau internal details
- ‚úÖ Credential verification menggunakan generic message (tidak membedakan username/password salah)
- ‚úÖ Authorization errors memberikan pesan jelas tanpa expose struktur data

---

## üöÄ Kesimpulan

**STATUS: ‚úÖ KRITERIA 5 TERPENUHI SEMPURNA!**

Aplikasi OpenMusic API sudah menerapkan Error Handling yang lengkap dan robust:

1. ‚úÖ **6 jenis error** sudah terimplementasi dengan benar
2. ‚úÖ **Consistent response structure** (`status` + `message`)
3. ‚úÖ **Exception class hierarchy** yang terorganisir
4. ‚úÖ **Global error handler** di `onPreResponse` hook
5. ‚úÖ **Proper status codes** untuk setiap error type
6. ‚úÖ **Security best practices** (tidak expose internal details)
7. ‚úÖ **Indonesian error messages** yang deskriptif
8. ‚úÖ **Error logging** untuk debugging

**Tidak ada yang perlu ditambahkan atau diperbaiki!** üéâ

Semua error handling sudah:
- ‚úÖ Menggunakan status code yang tepat
- ‚úÖ Menggunakan `status: "fail"` untuk client errors
- ‚úÖ Menggunakan `status: "error"` untuk server errors
- ‚úÖ Memiliki message yang tidak kosong dan deskriptif
- ‚úÖ Ditangani secara konsisten di seluruh aplikasi
